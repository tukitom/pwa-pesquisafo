<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa Interativo FO Flores</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css">
<link rel="stylesheet" href="styles.css">
<style>
  #map {
    width: 100%;
    height: 85vh;
    border-radius: 8px;
  }
  #searchBox {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
  }
  nav {
    display: flex;
    gap: 8px;
    background-color: #2B2B2B;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  #btnDownload {
    display: none; /* S√≥ aparece no modo editor */
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #btnDownload:hover {
    background-color: #45a049;
  }
</style>
</head>
<body>
<header>
  <nav>
    <button onclick="window.location.href='index.html'">üè† In√≠cio</button>
    <button onclick="window.location.href='app.html'">üìÇ CSV</button>
    <button onclick="window.location.href='calculadora.html'">üé® Calculadora</button>
    <button onclick="window.location.href='mapa.html'">üó∫Ô∏è Mapa</button>
  </nav>
</header>

<div id="searchBox">
  <input id="searchInput" type="text" placeholder="Ex: PDO1001 ou JFO1001...">
  <select id="filterSelect">
    <option value="todos">Todos</option>
    <option value="pdo">S√≥ PDOs</option>
    <option value="jfo">S√≥ Juntas</option>
  </select>
  <button id="btnSearch">Procurar</button>
</div>

<div id="map"></div>

<!-- Bot√£o para descarregar JSON (s√≥ aparece no modo edi√ß√£o) -->
<button id="btnDownload">üíæ Descarregar JSON atualizado</button>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
  // ---- CONFIGURA√á√ÉO DE EDI√á√ÉO ----
  let modoEditor = false;

  if (confirm("Ativar modo de edi√ß√£o? (Apenas para o administrador)")) {
    const senha = prompt("Digite a senha de edi√ß√£o:");
    if (senha === "flores123") { // <-- altera a senha aqui
      modoEditor = true;
      alert("Modo de edi√ß√£o ativado!");
      document.getElementById("btnDownload").style.display = "inline-block";
    } else {
      alert("Senha incorreta. Apenas visualiza√ß√£o.");
    }
  }

  // Inicializar o mapa com imagem de sat√©lite Esri
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        esri: {
          type: 'raster',
          tiles: [
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          tileSize: 256,
          attribution: '¬© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
        }
      },
      layers: [
        {
          id: 'esri-imagery',
          type: 'raster',
          source: 'esri',
          minzoom: 0,
          maxzoom: 19
        }
      ]
    },
    center: [-31.13, 39.454],
    zoom: 13,
    pitch: 0,
    bearing: 0,
    attributionControl: true
  });

  // Controles de navega√ß√£o
  map.addControl(new maplibregl.NavigationControl());

  let todosOsMarkers = [];
  let data = null; // Aqui guardaremos o GeoJSON original

  // Carregar e exibir marcadores
  fetch("Locais etiquetados.json")
    .then(res => res.json())
    .then(json => {
      data = json; // guarda o JSON original completo

      data.features.forEach(f => {
        const [lng, lat] = f.geometry.coordinates;
        const nome = f.properties.name;
        const tipo = nome.toLowerCase().includes("jfo") ? "jfo" : "pdo";
        const color = tipo === "jfo" ? "lime" : "dodgerblue";

        const el = document.createElement('div');
        el.style.backgroundColor = color;
        el.style.width = '16px';
        el.style.height = '16px';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';

        const popup = new maplibregl.Popup({ closeButton: true })
          .setHTML(`<div style="color: black;"><b>${nome}</b></div>`);

        const marker = new maplibregl.Marker(el, { draggable: modoEditor })
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(map);

        // Se estiver no modo editor, permite mover e atualizar as coordenadas
        if (modoEditor) {
          marker.on('dragend', () => {
            const novaPos = marker.getLngLat();
            f.geometry.coordinates = [novaPos.lng, novaPos.lat];
            console.log(`Atualizado: ${nome}`, novaPos);
          });
        }

        todosOsMarkers.push({ nome, tipo, marker });
      });
    });

  // Pesquisa manual
  document.getElementById("btnSearch").addEventListener("click", () => {
    const termo = document.getElementById("searchInput").value.trim().toLowerCase();
    if (!termo) return alert("Escreve o nome do PDO ou JFO.");
    const encontrado = todosOsMarkers.find(m => m.nome.toLowerCase().includes(termo));
    if (!encontrado) return alert("Local n√£o encontrado!");
    const pos = encontrado.marker.getLngLat();
    map.flyTo({ center: pos, zoom: 17, speed: 0.8 });
    encontrado.marker.togglePopup();
  });

  // Filtro de tipo
  document.getElementById("filterSelect").addEventListener("change", (e) => {
    const filtro = e.target.value;
    todosOsMarkers.forEach(({ tipo, marker }) => {
      if (filtro === "todos" || filtro === tipo) marker.addTo(map);
      else marker.remove();
    });
  });

  // Bot√£o de download manual
  document.getElementById("btnDownload").addEventListener("click", () => {
    if (!data) return alert("Os dados ainda n√£o foram carregados.");
    guardarAlteracoes();
  });

  // Fun√ß√£o para descarregar JSON atualizado
  function guardarAlteracoes() {
    const jsonData = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonData], { type: "application/json" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Locais etiquetados.json";
    a.click();

    alert("Ficheiro JSON atualizado foi descarregado!\nSubstitui o antigo no GitHub.");
  }
</script>
</body>
</html>
