<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa FO Flores</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css">
<link rel="stylesheet" href="styles.css">
<style>
  #map {
    width: 100%;
    height: 85vh;
    border-radius: 8px;
  }
  #searchBox {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
  }
  nav {
    display: flex;
    gap: 8px;
    background-color: #2B2B2B;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>
<header>
  <nav>
    <button onclick="window.location.href='index.html'">ğŸ  InÃ­cio</button>
    <button onclick="window.location.href='app.html'">ğŸ“‚ CSV</button>
    <button onclick="window.location.href='calculadora.html'">ğŸ¨ Calculadora</button>
    <button onclick="window.location.href='mapa.html'">ğŸ—ºï¸ Mapa</button>
  </nav>
</header>

<div id="searchBox">
  <input id="searchInput" type="text" placeholder="Ex: PDO1001 ou JFO1001...">
  <select id="filterSelect">
    <option value="todos">Todos</option>
    <option value="pdo">SÃ³ PDOs</option>
    <option value="jfo">SÃ³ Juntas</option>
  </select>
  <button id="btnSearch">Procurar</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
  // === Mapa base nÃ­tido (ruas)
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/streets/style.json?key=Cj5w3ovW3aR8RGpiAoug',
    center: [-31.13, 39.454],
    zoom: 14,
    pitch: 0,
    dragRotate: true,
    pitchWithRotate: false,
    touchZoomRotate: true,
    attributionControl: true
  });

  map.addControl(new maplibregl.NavigationControl({ visualizePitch: false }));

  // BotÃ£o norte
  const btnReset = document.createElement('button');
  btnReset.textContent = 'ğŸ”„ Norte para cima';
  btnReset.style.position = 'absolute';
  btnReset.style.top = '10px';
  btnReset.style.right = '10px';
  btnReset.style.zIndex = '10';
  btnReset.style.padding = '6px 10px';
  btnReset.style.background = '#2B2B2B';
  btnReset.style.color = 'white';
  btnReset.style.border = 'none';
  btnReset.style.borderRadius = '6px';
  btnReset.onclick = () => map.easeTo({ bearing: 0, pitch: 0 });
  document.body.appendChild(btnReset);

  let todosOsMarkers = [];

  // === Carregar Locais etiquetados.json ===
  fetch("Locais etiquetados.json")
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        const coords = f.geometry?.coordinates;
        if (!coords || coords.length < 2) return;

        const [lng, lat] = coords;
        const nome = String(f.properties?.name || "Sem nome").trim();
        const tipo = nome.toLowerCase().includes("jfo") ? "jfo" : "pdo";
        const color = tipo === "jfo" ? "#00FF00" : "#007BFF";

        const el = document.createElement("div");
        el.style.backgroundColor = color;
        el.style.width = "16px";
        el.style.height = "16px";
        el.style.borderRadius = "50%";
        el.style.border = "2px solid white";
        el.style.cursor = "pointer";

        // ğŸ”§ Popup sÃ³ com o nome
        const popup = new maplibregl.Popup({ offset: 25 })
          .setHTML(`<b style="font-family:Arial,sans-serif;font-size:14px;">${nome}</b>`);

        const marker = new maplibregl.Marker(el)
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(map);

        todosOsMarkers.push({ nome, tipo, marker });
      });
    })
    .catch(err => {
      console.error("Erro ao carregar Locais etiquetados.json:", err);
      alert("Erro ao carregar o ficheiro de locais.");
    });

  // === Pesquisa manual ===
  document.getElementById("btnSearch").addEventListener("click", () => {
    const termo = document.getElementById("searchInput").value.trim().toLowerCase();
    if (!termo) return alert("Escreve o nome do PDO ou JFO.");
    const encontrado = todosOsMarkers.find(m => m.nome.toLowerCase().includes(termo));
    if (!encontrado) return alert("Local nÃ£o encontrado!");
    const pos = encontrado.marker.getLngLat();
    map.flyTo({ center: pos, zoom: 17, speed: 0.8 });
    encontrado.marker.togglePopup();
  });

  // === Filtro PDO / JFO ===
  document.getElementById("filterSelect").addEventListener("change", (e) => {
    const filtro = e.target.value;
    todosOsMarkers.forEach(({ tipo, marker }) => {
      if (filtro === "todos" || filtro === tipo) marker.addTo(map);
      else marker.remove();
    });
  });
</script>
</body>
</html>
